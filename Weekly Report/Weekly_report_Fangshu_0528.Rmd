---
title: "Weekly report"
author: "Fangshu Ye"
date: "5/28/2020"
output: html_document
---

### 0. What I did this week
- Modify the first part: **Data Checking** (remove the outlier of age; drop the data from people who are not consistent with MostAttach)
- Almost finished the third part: **Cat owners versus dogs owners**

### 1. Remaining questions

```{r,echo=FALSE,message=FALSE,warning=FALSE}
rm(list = ls())
setwd('/Users/fangshu/Desktop/research/Analysis_pets_isolation/COVIDandPETS-master/cleaned_data/')
library(dplyr)
library(ggplot2)
library(lme4)
library(knitr)
library(kableExtra)
library(ordinal)
library(mclogit)
rawdatalist <- list()
for (d in 1:2) {
  rawdatalist[[d]] <- read.csv(paste0("wave",d,"_cleaned_0527.csv"))
}
workerid_twice <- intersect(rawdatalist[[1]]$workerId,rawdatalist[[2]]$workerId)
alldata <- c()
for (d in 1:2) {
  rawdatalist[[d]] <- rawdatalist[[d]] %>%
    filter(PetOwner==1) %>%
    filter(MostAttach %in% c(1,2))
  
  wave <- data.frame(select(rawdatalist[[d]],workerId,MostAttach,
                           #age,gender,
                           Compliance,Interact,Plans,PlansWho,Concern,CCAS1,CCAS2,CCAS3,CCAS4,CCAS5,
                           CCAS6,CCAS7,CCAS8,CCAS9,CCAS10,CCAS11,CCAS12,CCAS13))
  timepoint <- paste0("T",d)
  
  wave$time <- rep(timepoint,nrow(wave))
  
  alldata <- rbind(alldata,wave)
}
alldata <- alldata %>%
  mutate(num=ifelse(workerId %in% workerid_twice,"twice","once")) 

cols <- colnames(alldata)
alldata[cols] <- lapply(alldata[cols], factor) 
levels(alldata$MostAttach) <- c("Dog","Cat")
```

<span style="color: red;">Q1:</span> Select the variables that we're gone to analyze.


![](/Users/fangshu/Desktop/research/Analysis_pets_isolation/Cat_Dog/summarytable.png)

<span style="color: red;">Q2:</span> 'Twice' or 'Once and Twice'

Here we take **Interact** for example:

```{r both Interact plot,echo=FALSE,fig.height=3.5,fig.width=4.5, fig.align = "center"}
sumdata1 <- alldata %>%
  group_by(time,MostAttach) %>%
  summarise(count = n())
countsum <- rep(sumdata1$count,each=2)
sumdata2 <- alldata %>%
  group_by(time,MostAttach,Interact) %>%
  summarise(percent = n())
sumdata2$percent <- sumdata2$percent/countsum

ggplot(sumdata2, aes(x=MostAttach,y=percent,fill=Interact))+geom_col(width = 0.5)+facet_grid(time~.)+
  geom_text(aes(label = scales::percent(percent)),position = position_stack(vjust = .5))+
  ggtitle("using once and twice")
```


```{r twice Interact plot,echo=FALSE,fig.height=3.5,fig.width=4.5, fig.align = "center"}
sumdata1 <- alldata %>%
  filter(num=="twice") %>%
  group_by(time,MostAttach) %>%
  summarise(count = n())
countsum <- rep(sumdata1$count,each=2)
sumdata2 <- alldata %>%
  filter(num=="twice") %>%
  group_by(time,MostAttach,Interact) %>%
  summarise(percent = n())
sumdata2$percent <- sumdata2$percent/countsum
ggplot(sumdata2, aes(x=MostAttach,y=percent,fill=Interact))+geom_col(width = 0.5)+facet_grid(time~.)+
  geom_text(aes(label = scales::percent(percent)),position = position_stack(vjust = .5))+
  ggtitle("using twice")
```

```{r wave1 Interact model,echo=FALSE}
m1 <- glm(Interact ~ MostAttach, data = alldata[alldata$time=="T1",], family = "binomial")
m2 <- glm(Interact ~ MostAttach, data = alldata[which(alldata$time=="T1" & alldata$num=="twice"),], family = "binomial")
coef <- rbind(summary(m1)$coef[2,],summary(m2)$coef[2,])
row.names(coef) <- c("include both once and twice","only twice")
coef %>%
  kable(caption = "Coef of 'MostAttachCat' in logistic regression 'Interact ~ MostAttach', using WAVE1") %>%
  kable_styling()
```


```{r wave2 Interact model,echo=FALSE}
m1 <- glm(Interact ~ MostAttach, data = alldata[alldata$time=="T2",], family = "binomial")
m2 <- glm(Interact ~ MostAttach, data = alldata[which(alldata$time=="T2" & alldata$num=="twice"),], family = "binomial")
coef <- rbind(summary(m1)$coef[2,],summary(m2)$coef[2,])
row.names(coef) <- c("include both once and twice","only twice")
coef %>%
  kable(caption = "Coef of 'MostAttachCat' in logistic regression 'Interact ~ MostAttach', using WAVE2") %>%
  kable_styling()
```


```{r wave1+2 Interact model,echo=FALSE}
m1 <- glmer(Interact ~ MostAttach + time + (1|workerId), data = alldata, family = "binomial")
m2 <- glmer(Interact ~ MostAttach + time + (1|workerId), data = alldata[which(alldata$num=="twice"),], family = "binomial")

coef <- rbind(summary(m1)$coef[-1,],summary(m2)$coef[-1,])
coef %>%
  kable(caption = "Coef of 'MostAttachCat' and 'timeT2' in logistic regression 'Interact ~ MostAttach + time + (1|workerId)', using WAVE1+WAVE2") %>%
  kable_styling()%>%
  pack_rows("include both once and twice", 1, 2) %>%
  pack_rows("only twice", 3, 4)
```

<span style="color: blue;">use once+twice in the following analysis</span> 

### 2. Modeling reuslt

Data size:
```{r data size}
table(alldata$time)
```

#### 2.1 Common questions for wave1 and wave2

##### 2.1.1 **Compliance** (Yes:1;No:0) : Does your pet/companion animal(s) influence your compliance with quarantine recommendations and requirements in your region?

```{r Compliance plot, echo=FALSE,fig.height=3.5,fig.width=4.5, fig.align = "center"}
sumdata1 <- alldata %>%
  group_by(time,MostAttach) %>%
  summarise(count = n())

sumdata2 <- alldata %>%
  group_by(time,MostAttach,Compliance) %>%
  summarise(percent = n())

sumdata2 <- merge(sumdata2,sumdata1,by=c("time","MostAttach"))
sumdata2$percent <- sumdata2$percent/sumdata2$count

ggplot(sumdata2, aes(x=MostAttach,y=percent,fill=Compliance))+geom_col(width = 0.5)+facet_grid(time~.)+
  geom_text(aes(label = scales::percent(percent)),position = position_stack(vjust = .5))
```

```{r Compliance model, echo=FALSE}
m1 <- glm(Compliance ~ MostAttach, data = alldata[alldata$time=="T1",], family = "binomial")
m2 <- glm(Compliance ~ MostAttach, data = alldata[alldata$time=="T2",], family = "binomial")
m3 <- glmer(Compliance ~ MostAttach + time + (1|workerId), data = alldata, family = "binomial")
m4 <- glmer(Compliance ~ MostAttach + time + MostAttach*time + (1|workerId), data = alldata, family = "binomial")
coef <- rbind(summary(m1)$coef[-1,],summary(m2)$coef[-1,],summary(m3)$coef[-1,],summary(m4)$coef[-1,])
row.names(coef)[1:2] <- c("MostAttachCat","MostAttachCat")
colnames(coef)[4] <- "pvalue"

colns <- colnames(coef)
rowns <- rownames(coef)
coef <- coef %>%
  as.data.frame() %>%
  mutate(Logistic=rowns) %>%
  mutate(pvalue=round(pvalue,4)) %>%
  select(Logistic,colns[-3])

coef %>%
  mutate(pvalue = cell_spec(pvalue, color = ifelse(pvalue < 0.05, "red", "black"))) %>%
  kable(format = "html", escape = F) %>%
  kable_styling()%>%
  pack_rows("T1: Compliance ~ MostAttach", 1, 1) %>%
  pack_rows("T2: Compliance ~ MostAttach", 2, 2) %>%
  pack_rows("T1+T2: Compliance ~ MostAttach + time + (1|workerId)", 3, 4) %>%
  pack_rows("T1+T2: Compliance ~ MostAttach + time + MostAttach*time + (1|workerId)", 5, 7)

```

##### 2.1.2 **Interact** (Yes:1;No:0) : Has COVID-19 affected your normal activities and interactions with your pet/companion animal(s)?
```{r Interact plot, echo=FALSE,fig.height=3.5,fig.width=4.5, fig.align = "center"}
sumdata1 <- alldata %>%
  group_by(time,MostAttach) %>%
  summarise(count = n())

sumdata2 <- alldata %>%
  group_by(time,MostAttach,Interact) %>%
  summarise(percent = n())

sumdata2 <- merge(sumdata2,sumdata1,by=c("time","MostAttach"))
sumdata2$percent <- sumdata2$percent/sumdata2$count

ggplot(sumdata2, aes(x=MostAttach,y=percent,fill=Interact))+geom_col(width = 0.5)+facet_grid(time~.)+
  geom_text(aes(label = scales::percent(percent)),position = position_stack(vjust = .5))
```

```{r Interact model, echo=FALSE}
m1 <- glm(Interact ~ MostAttach, data = alldata[alldata$time=="T1",], family = "binomial")
m2 <- glm(Interact ~ MostAttach, data = alldata[alldata$time=="T2",], family = "binomial")
m3 <- glmer(Interact ~ MostAttach + time + (1|workerId), data = alldata, family = "binomial")
m4 <- glmer(Interact ~ MostAttach + time + MostAttach*time + (1|workerId), data = alldata, family = "binomial")
coef <- rbind(summary(m1)$coef[-1,],summary(m2)$coef[-1,],summary(m3)$coef[-1,],summary(m4)$coef[-1,])
row.names(coef)[1:2] <- c("MostAttachCat","MostAttachCat")
colnames(coef)[4] <- "pvalue"

colns <- colnames(coef)
rowns <- rownames(coef)
coef <- coef %>%
  as.data.frame() %>%
  mutate(Logistic=rowns) %>%
  mutate(pvalue=round(pvalue,4)) %>%
  select(Logistic,colns[-3])

coef %>%
  mutate(pvalue = cell_spec(pvalue, color = ifelse(pvalue < 0.05, "red", "black"))) %>%
  kable(format = "html", escape = F) %>%
  kable_styling()%>%
  pack_rows("T1: Interact ~ MostAttach", 1, 1) %>%
  pack_rows("T2: Interact ~ MostAttach", 2, 2) %>%
  pack_rows("T1+T2: Interact ~ MostAttach + time + (1|workerId)", 3, 4) %>%
  pack_rows("T1+T2: Interact ~ MostAttach + time + MostAttach*time + (1|workerId)", 5, 7)
```

##### 2.1.3 **Plans** (Yes:1;No:0): Since the COVID-19 outbreak, have you made plans for caring for your pet/companion animal(s) should you become sick and unable to care for them?

```{r Plans plot, echo=FALSE,fig.height=3.5,fig.width=4.5, fig.align = "center"}
sumdata1 <- alldata %>%
  group_by(time,MostAttach) %>%
  summarise(count = n())

sumdata2 <- alldata %>%
  group_by(time,MostAttach,Plans) %>%
  summarise(percent = n())

sumdata2 <- merge(sumdata2,sumdata1,by=c("time","MostAttach"))
sumdata2$percent <- sumdata2$percent/sumdata2$count

ggplot(sumdata2, aes(x=MostAttach,y=percent,fill=Plans))+geom_col(width = 0.5)+facet_grid(time~.)+
  geom_text(aes(label = scales::percent(percent)),position = position_stack(vjust = .5))
```

```{r Plans model, echo=FALSE}
m1 <- glm(Plans ~ MostAttach, data = alldata[alldata$time=="T1",], family = "binomial")
m2 <- glm(Plans ~ MostAttach, data = alldata[alldata$time=="T2",], family = "binomial")
m3 <- glmer(Plans ~ MostAttach + time + (1|workerId), data = alldata, family = "binomial")
m4 <- glmer(Plans ~ MostAttach + time + MostAttach*time + (1|workerId), data = alldata, family = "binomial")
coef <- rbind(summary(m1)$coef[-1,],summary(m2)$coef[-1,],summary(m3)$coef[-1,],summary(m4)$coef[-1,])
row.names(coef)[1:2] <- c("MostAttachCat","MostAttachCat")
colnames(coef)[4] <- "pvalue"

colns <- colnames(coef)
rowns <- rownames(coef)
coef <- coef %>%
  as.data.frame() %>%
  mutate(Logistic=rowns) %>%
  mutate(pvalue=round(pvalue,4)) %>%
  select(Logistic,colns[-3])

coef %>%
  mutate(pvalue = cell_spec(pvalue, color = ifelse(pvalue < 0.05, "red", "black"))) %>%
  kable(format = "html", escape = F) %>%
  kable_styling()%>%
  pack_rows("T1: Plans ~ MostAttach", 1, 1) %>%
  pack_rows("T2: Plans ~ MostAttach", 2, 2) %>%
  pack_rows("T1+T2: Plans ~ MostAttach + time + (1|workerId)", 3, 4) %>%
  pack_rows("T1+T2: Plans ~ MostAttach + time + MostAttach*time + (1|workerId)", 5, 7)
```


##### 2.1.4 **Concern**(1-5: Not at all concerned to Extremely concerned): Overall, how concerned are you about your ability to care for your pets/companion animal(s)?

```{r Concern plot, echo=FALSE,fig.height=4,fig.width=5, fig.align = "center"}
sumdata1 <- alldata %>%
  filter(Plans==1) %>%
  group_by(time,MostAttach) %>%
  summarise(count = n())

sumdata2 <- alldata %>%
  filter(Plans==1) %>%
  group_by(time,MostAttach,Concern) %>%
  summarise(percent = n())

sumdata2 <- merge(sumdata2,sumdata1,by=c("time","MostAttach"))
sumdata2$percent <- sumdata2$percent/sumdata2$count

levels(sumdata2$Concern) <- c("Not at all concerned","A little concerned ",
                               "Moderately concerened","Very concerned",
                               "Extremely concerned")

ggplot(sumdata2, aes(x=MostAttach,y=percent,fill=Concern))+geom_col(width = 0.5)+facet_grid(time~.)+
  geom_text(aes(label = scales::percent(percent)),position = position_stack(vjust = .5))+
  ggtitle("How concerned are you about your ability \n to care for your pets/companion animal(s)?")
```


```{r Concern model, echo=FALSE}
m <- clmm(Concern ~ MostAttach + time + MostAttach*time + (1|workerId), data = alldata)
coef_4 <- summary(m)$coefficients
coef <- coef_4[(nrow(coef_4)-2):nrow(coef_4),]
coef %>%
  kable(format = "html", escape = F,caption = "Ordinal Logistic Regression: Concern ~ MostAttach + time + MostAttach*time + (1|workerId)")
```


##### 2.1.5 CCAS1-13
```{r CCAS1-13 model, echo=FALSE,warning=FALSE}
coef <- c()
for(q in 1:13){
  formula <- as.formula(paste0("CCAS",q,"~","MostAttach + time + MostAttach*time + (1|workerId)"))
  m <- clmm(formula, data = alldata)
  coef_q <- summary(m)$coefficients
  coef <- rbind(coef,coef_q[(nrow(coef_q)-2):nrow(coef_q),])
}

colnames(coef)[4] <- "pvalue"

colns <- colnames(coef)
rowns <- rownames(coef)
coef <- coef %>%
  as.data.frame() %>%
  mutate(Ordinal=rowns) %>%
  mutate(pvalue=round(pvalue,4)) %>%
  select(Ordinal,colns[-3])

coef %>%
  mutate(pvalue = cell_spec(pvalue, color = ifelse(pvalue < 0.05, "red", "black"))) %>%
  kable(format = "html", escape = F,caption = "Ordinal Logistic Regression: y ~ MostAttach + time + MostAttach*time + (1|workerId)") %>%
  kable_styling()%>%
  pack_rows("CCAS1: My pet/animal provides me with companionship", 1, 3) %>%
  pack_rows("CCAS2: Having a pet/animal gives me something to care for", 4, 6) %>%
  pack_rows("CCAS3: My pet/animal provides me with pleasurable activity", 7, 9) %>%
  pack_rows("CCAS4: My pet/animal is a source of constancy in my life", 10, 12) %>%
  pack_rows("CCAS5: My pet/animal makes me feel needed", 13, 15) %>%
  pack_rows("CCAS6: My pet/animal makes me feel safe", 16, 18) %>%
  pack_rows("CCAS7: My pet/animal makes me play and laugh", 19, 21) %>%
  pack_rows("CCAS8: Having a pet/animal gives me something to love", 22, 24) %>%
  pack_rows("CCAS9: I get more exercise because of my pet/animal", 25, 27) %>%
  pack_rows("CCAS10: I get comfort from touching my pet/animal", 28, 30) %>%
  pack_rows("CCAS11: I enjoy watching my pet/animal", 31, 33) %>%
  pack_rows("CCAS12: My pet/animal makes me feel loved", 34, 36) %>%
  pack_rows("CCAS13: My pet/animal makes me feel trusted", 37, 39)
```


```{r CCAS2, echo=FALSE,fig.height=4,fig.width=6, fig.align = "center"}
sumdata1 <- alldata %>%
  filter(Plans==1) %>%
  group_by(time,MostAttach) %>%
  summarise(count = n())

sumdata2 <- alldata %>%
  filter(Plans==1) %>%
  group_by(time,MostAttach,CCAS2) %>%
  summarise(percent = n())

sumdata2 <- merge(sumdata2,sumdata1,by=c("time","MostAttach"))
sumdata2$percent <- sumdata2$percent/sumdata2$count

# no 1
levels(sumdata2$CCAS2) <- c("Disagree",
                               "Somewhat disagree","Neither agree nor disagree",
                               "Somewhat agree","Agree","Strongly agree")

ggplot(sumdata2, aes(x=MostAttach,y=percent,fill=CCAS2))+geom_col(width = 0.5)+facet_grid(time~.)+
  geom_text(aes(label = scales::percent(percent)),position = position_stack(vjust = .5))+
  ggtitle("CCAS2: Having a pet/animal gives me something to care for")
```

#### 2.2 Unique questions for wave2
```{r,echo=FALSE}
wave2 <- data.frame(select(rawdatalist[[2]],workerId,MostAttach,
                           NonVetService,NonVetLessFreq,
                           VetVisit,VetVisitFreq,
                           PetHealth,))
cols <- colnames(wave2)
wave2[cols] <- lapply(wave2[cols], factor) 
levels(wave2$MostAttach) <- c("Dog","Cat")
```

##### 2.2.1 **\textcolor{blue}{NonVetService}** (Yes:1;No:0) : In the past 12 months have you used an animal care service that does NOT normally require a veterinarian?

```{r NonVetService plot, echo=FALSE,fig.height=3.5,fig.width=4.5, fig.align = "center"}
sumdata1 <- wave2 %>%
  group_by(MostAttach) %>%
  summarise(count = n())

sumdata2 <- wave2 %>%
  group_by(MostAttach,NonVetService) %>%
  summarise(percent = n())

sumdata2 <- merge(sumdata2,sumdata1,by=c("MostAttach"))
sumdata2$percent <- sumdata2$percent/sumdata2$count

ggplot(sumdata2, aes(x=MostAttach,y=percent,fill=NonVetService))+geom_col(width = 0.5)+
  geom_text(aes(label = scales::percent(percent)),position = position_stack(vjust = .5))
```

```{r NonVetService model, echo=FALSE}
m <- glm(NonVetService ~ MostAttach, data = wave2, family = "binomial")
summary(m)$coef
```

##### 2.2.2 **\textcolor{blue}{NonVetLessFreq}** (Yes:1;No:0) : Thinking about the time since the COVID-19 outbreak began, have you used any of these non-veterinary services less frequently than before the outbreak began?

```{r NonVetLessFreq plot, echo=FALSE,fig.height=3.5,fig.width=4.5, fig.align = "center"}
sumdata1 <- wave2 %>%
  filter(NonVetService==1) %>%
  group_by(MostAttach) %>%
  summarise(count = n())

sumdata2 <- wave2 %>%
  filter(NonVetService==1) %>%
  group_by(MostAttach,NonVetLessFreq) %>%
  summarise(percent = n())

sumdata2 <- merge(sumdata2,sumdata1,by=c("MostAttach"))
sumdata2$percent <- sumdata2$percent/sumdata2$count

ggplot(sumdata2, aes(x=MostAttach,y=percent,fill=NonVetLessFreq))+geom_col(width = 0.5)+
  geom_text(aes(label = scales::percent(percent)),position = position_stack(vjust = .5))
```

```{r NonVetLessFreq model, echo=FALSE}
wave2_nonfreq <- wave2 %>%
  filter(NonVetService==1)
m <- glm(NonVetLessFreq ~ MostAttach, data = wave2_nonfreq, family = "binomial")
summary(m)$coef
```


##### 2.2.3 **\textcolor{teal}{VetVisit}** (Yes:1;No:0): In the past 12 months, have you visited a veterinarian for preventative care for your pet? 


```{r VetVisit plot, echo=FALSE,fig.height=3.5,fig.width=4.5, fig.align = "center"}
sumdata1 <- wave2 %>%
  group_by(MostAttach) %>%
  summarise(count = n())

sumdata2 <- wave2 %>%
  group_by(MostAttach,VetVisit) %>%
  summarise(percent = n())

sumdata2 <- merge(sumdata2,sumdata1,by=c("MostAttach"))
sumdata2$percent <- sumdata2$percent/sumdata2$count

ggplot(sumdata2, aes(x=MostAttach,y=percent,fill=VetVisit))+geom_col(width = 0.5)+
  geom_text(aes(label = scales::percent(percent)),position = position_stack(vjust = .5))
```

```{r VetVisit model, echo=FALSE}
m <- glm(VetVisit ~ MostAttach, data = wave2, family = "binomial")
summary(m)$coef
```

##### 2.2.4 **\textcolor{teal}{VetLessFreq}** (Yes:1;No:0) : Thinking about the time since the COVID-19 outbreak began, have you used these preventative veterinary services less frequently than before the outbreak began?

```{r VetVisitFreq plot, echo=FALSE,fig.height=3.5,fig.width=4.5, fig.align = "center"}
sumdata1 <- wave2 %>%
  filter(VetVisit==1) %>%
  group_by(MostAttach) %>%
  summarise(count = n())

sumdata2 <- wave2 %>%
  filter(VetVisit==1) %>%
  group_by(MostAttach,VetVisitFreq) %>%
  summarise(percent = n())

sumdata2 <- merge(sumdata2,sumdata1,by=c("MostAttach"))
sumdata2$percent <- sumdata2$percent/sumdata2$count

ggplot(sumdata2, aes(x=MostAttach,y=percent,fill=VetVisitFreq))+geom_col(width = 0.5)+
  geom_text(aes(label = scales::percent(percent)),position = position_stack(vjust = .5))
```

```{r VetLessFreq model, echo=FALSE}
wave2_nonfreq <- wave2 %>%
  filter(VetVisit==1)
m <- glm(VetVisitFreq ~ MostAttach, data = wave2_nonfreq, family = "binomial")
summary(m)$coef
```



##### 2.2.5 **\textcolor{purple}{PetHealth}**(Yes:1;No:0): Thinking about the time since the COVID-19 outbreak began, has your pet had any health issues (e.g. been sick or injured) that required a veterinarian? 

```{r PetHealth plot, echo=FALSE,fig.height=3.5,fig.width=4.5, fig.align = "center"}
sumdata1 <- wave2 %>%
  group_by(MostAttach) %>%
  summarise(count = n())

sumdata2 <- wave2 %>%
  group_by(MostAttach,PetHealth) %>%
  summarise(percent = n())

sumdata2 <- merge(sumdata2,sumdata1,by=c("MostAttach"))
sumdata2$percent <- sumdata2$percent/sumdata2$count

ggplot(sumdata2, aes(x=MostAttach,y=percent,fill=PetHealth))+geom_col(width = 0.5)+
  geom_text(aes(label = scales::percent(percent)),position = position_stack(vjust = .5))
```

```{r PetHealth model, echo=FALSE}
m <- glm(PetHealth ~ MostAttach, data = wave2, family = "binomial")
summary(m)$coef
```
